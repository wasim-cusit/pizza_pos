<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payment Display Debug</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .debug-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; }
        .payment-display { font-size: 24px; font-weight: bold; color: #2c3e50; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        .cart-item { padding: 10px; margin: 5px; background: #f8f9fa; border: 1px solid #dee2e6; }
    </style>
</head>
<body>
    <h1>Payment Display Debug</h1>
    
    <div class="debug-section">
        <h3>Payment Display</h3>
        <div class="payment-display" id="total-amount">Payment PKR 0.00</div>
        <div id="total-items">Item(s): 0</div>
    </div>
    
    <div class="debug-section">
        <h3>Cart Items</h3>
        <div id="cart-items"></div>
    </div>
    
    <div class="debug-section">
        <h3>Actions</h3>
        <button onclick="addTestItem()">Add Test Item (PKR 500)</button>
        <button onclick="addAnotherItem()">Add Another Item (PKR 300)</button>
        <button onclick="clearCart()">Clear Cart</button>
        <button onclick="forceUpdate()">Force Update Payment</button>
        <button onclick="showCartData()">Show Cart Data</button>
    </div>
    
    <div class="debug-section">
        <h3>Console Log</h3>
        <div id="console-log" style="background: #000; color: #0f0; padding: 10px; height: 200px; overflow-y: scroll; font-family: monospace;"></div>
    </div>

    <script>
        // Cart data structure
        let cart = [];
        
        // Override console.log to show in the debug area
        const originalLog = console.log;
        const originalError = console.error;
        const originalWarn = console.warn;
        
        function addToLog(message, type = 'log') {
            const logDiv = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.style.color = type === 'error' ? '#ff6b6b' : type === 'warn' ? '#ffd93d' : '#0f0';
            logEntry.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalLog.apply(console, args);
            addToLog(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalError.apply(console, args);
            addToLog(args.join(' '), 'error');
        };
        
        console.warn = function(...args) {
            originalWarn.apply(console, args);
            addToLog(args.join(' '), 'warn');
        };
        
        // Cart functions
        function addToCart(itemId, itemName, price, quantity = 1) {
            const safePrice = parseFloat(price) || 0;
            const safeQuantity = parseInt(quantity) || 1;
            const stringItemId = String(itemId);
            
            const existingItem = cart.find(item => String(item.id) === stringItemId);
            
            if (existingItem) {
                existingItem.quantity += safeQuantity;
                existingItem.totalPrice = existingItem.quantity * existingItem.price;
                console.log('Updated existing item:', existingItem);
            } else {
                const newItem = {
                    id: itemId,
                    name: itemName,
                    price: safePrice,
                    quantity: safeQuantity,
                    totalPrice: safePrice * safeQuantity
                };
                cart.push(newItem);
                console.log('Added new item:', newItem);
            }
            
            saveCartToStorage();
            updateCartDisplay();
        }
        
        function getCartTotal() {
            if (!Array.isArray(cart)) {
                console.warn('Cart is not an array:', cart);
                return 0;
            }
            console.log('getCartTotal called with cart:', cart);
            const total = cart.reduce((total, item) => {
                const itemPrice = parseFloat(item.totalPrice) || 0;
                console.log(`Item: ${item.name}, totalPrice: ${item.totalPrice}, parsed: ${itemPrice}`);
                return total + itemPrice;
            }, 0);
            console.log('getCartTotal returning:', total);
            return total;
        }
        
        function updateCartDisplay() {
            const cartItemsContainer = document.getElementById('cart-items');
            const totalAmount = document.getElementById('total-amount');
            const totalItems = document.getElementById('total-items');
            
            // Fix cart data
            if (cart && cart.length > 0) {
                cart.forEach(item => {
                    if (item.totalPrice === 0 || isNaN(item.totalPrice) || !item.totalPrice) {
                        item.totalPrice = item.price * item.quantity;
                    }
                });
                saveCartToStorage();
            }
            
            // Update cart items display
            if (cartItemsContainer) {
                cartItemsContainer.innerHTML = '';
                cart.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'cart-item';
                    itemDiv.innerHTML = `
                        <strong>${item.name}</strong> - Qty: ${item.quantity} - 
                        Price: PKR ${item.price} - Total: PKR ${item.totalPrice}
                    `;
                    cartItemsContainer.appendChild(itemDiv);
                });
            }
            
            // Update payment display
            if (totalAmount) {
                const total = getCartTotal();
                const safeTotal = typeof total === 'number' && !isNaN(total) ? total : 0;
                console.log('Updating payment display:', { total, safeTotal, cartLength: cart.length });
                totalAmount.textContent = `Payment PKR ${safeTotal.toFixed(2)}`;
            } else {
                console.error('totalAmount element not found!');
            }
            
            if (totalItems) {
                const totalQuantity = cart.reduce((sum, item) => sum + item.quantity, 0);
                totalItems.textContent = `Item(s): ${totalQuantity}`;
            }
        }
        
        function saveCartToStorage() {
            localStorage.setItem('pos_cart', JSON.stringify(cart));
        }
        
        function loadCartFromStorage() {
            const savedCart = localStorage.getItem('pos_cart');
            if (savedCart) {
                try {
                    const parsedCart = JSON.parse(savedCart);
                    if (Array.isArray(parsedCart)) {
                        cart = parsedCart.map(item => {
                            const mappedItem = {
                                id: item.id,
                                name: item.name || '',
                                price: parseFloat(item.price) || 0,
                                quantity: parseInt(item.quantity) || 1,
                                totalPrice: parseFloat(item.totalPrice) || 0
                            };
                            if (mappedItem.totalPrice === 0 || isNaN(mappedItem.totalPrice)) {
                                mappedItem.totalPrice = mappedItem.price * mappedItem.quantity;
                            }
                            return mappedItem;
                        });
                    } else {
                        cart = [];
                    }
                } catch (e) {
                    console.error('Error loading cart from storage:', e);
                    cart = [];
                }
            } else {
                cart = [];
            }
        }
        
        // Test functions
        function addTestItem() {
            addToCart(1, 'Test Pizza', 500, 1);
        }
        
        function addAnotherItem() {
            addToCart(2, 'Test Burger', 300, 1);
        }
        
        function clearCart() {
            cart = [];
            saveCartToStorage();
            updateCartDisplay();
        }
        
        function forceUpdate() {
            console.log('Force updating payment display...');
            updateCartDisplay();
        }
        
        function showCartData() {
            console.log('Current cart data:', cart);
            console.log('Cart total:', getCartTotal());
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadCartFromStorage();
            updateCartDisplay();
            console.log('Debug page initialized');
        });
    </script>
</body>
</html> 